// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  STUDENT
  MENTOR
  ADMIN
}

enum AuthProvider {
  GOOGLE
  GITHUB
  EMAIL_PASSWORD
}

enum EmailEventType {
  USER_SIGNUP
  USER_EMAIL_VERIFICATION
  PASSWORD_RESET
  ORDER_CREATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  MENTOR_SESSION_BOOKED
  MENTOR_SESSION_REMINDER
  AI_PROJECT_GENERATED
  PROJECT_APPROVED
  PAYMENT_FAILED
  LOW_STOCK_ALERT
}

enum ProjectType {
  FEATURED
  AI_GENERATED
  CUSTOM
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ProjectCategory {
  IOT                  // Internet of Things
  ROBOTICS             // Robots, Robotic Arms, etc.
  DRONE                // Drones, UAVs, Flying Robots
  AUTOMATION           // Home/Industrial Automation
  ENVIRONMENT          // Environment Monitoring, Green Tech
  HEALTH               // Healthcare, Medical Devices
  AGRICULTURE          // Smart Farming, Agri-Tech
  SECURITY             // Security Systems, Surveillance
  EDUCATION            // Educational Tools, Learning Kits
  AUTOMOTIVE           // Car Tech, Vehicle Automation
  SMART_HOME           // Home Automation, Smart Devices
  ENERGY               // Renewable Energy, Power Management
  WEARABLES            // Wearable Tech, Smart Watches
  GAMING               // Gaming Controllers, VR/AR
  MUSIC                // Musical Instruments, Audio Tech
  COMMUNICATION        // RF, Wireless, Communication Systems
  AI_ML                // Artificial Intelligence, Machine Learning
  COMPUTER_VISION      // Image Processing, Object Detection
  OTHER                // Miscellaneous
}

enum ProjectAssetType {
  CIRCUIT_DIAGRAM
  BLOCK_DIAGRAM
  IMAGE
  CODE_ZIP
  VIDEO
  OTHER
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderType {
  KIT_ONLY
  PROJECT_KIT
  COMPONENTS_ONLY
  BUILT_PROJECT
  PRE_BUILT_PROJECT
}

enum OrderItemType {
  KIT
  COMPONENT
  SERVICE
}

enum PaymentGateway {
  PHONEPE
  STRIPE
  TEST
}

enum PaymentStatus {
  CREATED
  SUCCESS
  FAILED
  REFUNDED
}

enum AIGenerationStatus {
  DRAFT
  ACCEPTED
  DISCARDED
}

enum MentorSessionStatus {
  REQUESTED
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum MentorRole {
  PRIMARY
  SECONDARY
}

enum FileType {
  PDF
  IMAGE
  CODE_ZIP
  OTHER
}

enum StudentListingType {
  COMPONENT
  PROJECT
  KIT
  OTHER
}

enum ItemCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
}

enum ListingStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SOLD
  REMOVED
}

enum StudentOrderStatus {
  PENDING_PAYMENT
  PAYMENT_SECURED
  SELLER_CONFIRMED
  ITEM_SHIPPED
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  avatarUrl String?
  role      UserRole @default(STUDENT)
  college   String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // relations
  authAccounts       AuthAccount[]
  credential         EmailCredential?
  sessions           Session[]
  emailNotifications EmailNotification[]

  // Project & orders
  createdProjects      Project[]
  orders               Order[]
  addresses            Address[]
  aiGenerationRequests AIGenerationRequest[]

  // Mentor
  mentorProfile   Mentor?
  studentSessions MentorSession[] @relation("StudentSessions")

  // Admin
  adminActionLogs AdminActionLog[]
  fileUploads     FileUpload[]
}

// OAuth / provider accounts (Google, GitHub, etc.)
model AuthAccount {
  id             String       @id @default(cuid())
  provider       AuthProvider
  providerUserId String // e.g. Google sub, GitHub id

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // optional: store tokens if you need them later
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime? @db.Timestamptz(6)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // one providerUserId per provider (prevents duplicates)
  @@unique([provider, providerUserId])
  @@index([userId])
}

// Email + password credentials (1-to-1 with User)
model EmailCredential {
  userId       String @id
  passwordHash String // store only a strong hash (bcrypt/argon2)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Optional but recommended for production if you don't want pure stateless JWT.
// You can also drop this and go full JWT if you prefer.
model Session {
  id        String  @id @default(cuid())
  userId    String
  token     String  @unique // random session token / JWT id
  userAgent String?
  ipAddress String?

  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model EmailNotification {
  id        String         @id @default(cuid())
  userId    String?
  email     String
  eventType EmailEventType
  subject   String
  body      String         @db.Text // Use Text for longer email content

  // Additional data (JSON) for email templates
  metadata Json? // Store order details, user details, etc.

  isSent Boolean   @default(false)
  sentAt DateTime? @db.Timestamptz(6)
  error  String?   @db.Text

  retryCount Int @default(0)
  maxRetries Int @default(3)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType, isSent])
  @@index([createdAt])
  @@index([isSent, retryCount])
}

// ========================================
// PROJECTS & DOCUMENTATION
// ========================================

model Project {
  id          String  @id @default(cuid())
  title       String
  slug        String  @unique
  summary     String? @db.Text
  description String? @db.Text

  // Categorization for better UX
  category    ProjectCategory // Main category (IoT, Robotics, Drone, etc.)
  tags        String[] // Additional tags for filtering (e.g., ["beginner-friendly", "arduino", "sensors"])
  
  projectType ProjectType     @default(FEATURED)
  difficulty  DifficultyLevel @default(BEGINNER)

  // Pricing & Time
  estimatedCostCents        Int? // DIY kit cost in paise/cents
  estimatedBuildTimeMinutes Int? // Time to complete

  // Pre-Built Option (Admin builds and lists)
  preBuiltAvailable  Boolean @default(false)
  preBuiltStock      Int     @default(0) // Available pre-built units
  preBuiltPriceCents Int? // Higher price for assembled version
  preBuiltImages     String[] // Photos of actual built units

  // Media
  thumbnailUrl String?
  youtubeUrl   String? // YouTube tutorial video URL
  
  // Visibility & Status
  isFeatured      Boolean @default(false) // Show on homepage
  isPublic        Boolean @default(true)
  isAIGenerated   Boolean @default(false) // From AI custom project
  publishedAt     DateTime? @db.Timestamptz(6)
  
  // Learning Info
  learningOutcomes String[] // What student will learn
  prerequisites    String[] // Required knowledge/skills
  
  // Stats
  viewCount      Int @default(0)
  buildCount     Int @default(0) // How many students built this
  averageRating  Float @default(0.0)
  
  // Relations
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  defaultMentorId String?
  defaultMentor   Mentor? @relation("DefaultMentorProjects", fields: [defaultMentorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // relations
  steps             ProjectStep[]
  documentBundle    ProjectDocumentBundle?
  assets            ProjectAsset[]
  projectComponents ProjectComponent[]
  kits              Kit[]
  aiResults         AIGenerationResult[]
  mentorAssignments ProjectMentor[]
  orders            Order[]
  mentorSessions    MentorSession[]
  fileUploads       FileUpload[]

  @@index([projectType, isPublic])
  @@index([category]) // For category filtering
  @@index([difficulty])
  @@index([isFeatured]) // For featured projects
  @@index([isAIGenerated]) // For AI projects
  @@index([slug])
  @@index([publishedAt])
}

model ProjectStep {
  id           String  @id @default(cuid())
  projectId    String
  stepNumber   Int
  title        String
  bodyMarkdown String  @db.Text
  pdfUrl       String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([projectId, stepNumber])
  @@index([projectId])
}

model ProjectDocumentBundle {
  id               String  @id @default(cuid())
  projectId        String  @unique
  abstract         String? @db.Text
  problemStatement String? @db.Text
  methodology      String? @db.Text
  applications     Json? // list of strings
  futureScope      Json? // list of strings

  pptUrl           String?
  fullReportPdfUrl String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
}

model ProjectAsset {
  id          String           @id @default(cuid())
  projectId   String
  assetType   ProjectAssetType
  url         String
  description String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([projectId, assetType])
}

model ProjectComponent {
  id          String  @id @default(cuid())
  projectId   String
  componentId String
  quantity    Int     @default(1)
  notes       String?

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@unique([projectId, componentId])
  @@index([componentId])
}

// ========================================
// COMPONENTS & KITS
// ========================================

model Component {
  id             String  @id @default(cuid())
  name           String
  sku            String? @unique
  description    String? @db.Text
  typicalUseCase String?
  vendorLink     String?
  imageUrl       String?

  unitPriceCents Int // price per unit
  stockQuantity  Int     @default(0)
  isActive       Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  projectComponents ProjectComponent[]
  kitComponents     KitComponent[]
  orderItems        OrderItem[]

  @@index([isActive])
  @@index([sku])
}

model Kit {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  imageUrl    String?

  priceCents    Int
  stockQuantity Int     @default(0)
  isActive      Boolean @default(true)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  kitComponents KitComponent[]
  orderItems    OrderItem[]

  @@index([isActive])
  @@index([projectId])
  @@index([slug])
}

model KitComponent {
  id          String @id @default(cuid())
  kitId       String
  componentId String
  quantity    Int    @default(1)

  kit       Kit       @relation(fields: [kitId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@unique([kitId, componentId])
  @@index([componentId])
}

// ========================================
// AI GENERATION
// ========================================

model AIGenerationRequest {
  id                  String           @id @default(cuid())
  userId              String?
  inputKeywords       String
  targetBudgetCents   Int?
  preferredHardware   Json? // e.g. ["ESP32", "Arduino"]
  requestedDifficulty DifficultyLevel?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  results AIGenerationResult[]

  @@index([userId])
}

model AIGenerationResult {
  id          String             @id @default(cuid())
  aiRequestId String
  projectId   String?
  status      AIGenerationStatus @default(DRAFT)
  rawResponse Json

  aiRequest AIGenerationRequest @relation(fields: [aiRequestId], references: [id], onDelete: Cascade)
  project   Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([aiRequestId])
  @@index([projectId])
  @@index([status])
}

// ========================================
// ORDERS, PAYMENTS, ADDRESSES
// ========================================

model Address {
  id        String  @id @default(cuid())
  userId    String
  name      String
  phone     String
  line1     String
  line2     String?
  city      String
  state     String
  pincode   String
  country   String  @default("India")
  isDefault Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
}

model Order {
  id        String      @id @default(cuid())
  userId    String
  addressId String
  orderType OrderType
  status    OrderStatus @default(PENDING_PAYMENT)

  totalAmountCents Int

  projectId String? // primary project context if any
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  notes String? @db.Text

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  address Address @relation(fields: [addressId], references: [id], onDelete: Restrict)

  items    OrderItem[]
  payments Payment[]

  @@index([userId])
  @@index([status])
  @@index([projectId])
}

model OrderItem {
  id       String        @id @default(cuid())
  orderId  String
  itemType OrderItemType

  kitId       String?
  componentId String?

  description    String
  quantity       Int    @default(1)
  unitPriceCents Int
  subtotalCents  Int

  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  kit       Kit?       @relation(fields: [kitId], references: [id], onDelete: SetNull)
  component Component? @relation(fields: [componentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([orderId])
  @@index([kitId])
  @@index([componentId])
}

model Payment {
  id                   String         @id @default(cuid())
  orderId              String
  gateway              PaymentGateway @default(PHONEPE)
  gatewayOrderId       String?
  gatewayTransactionId String?

  amountCents Int
  status      PaymentStatus @default(CREATED)

  rawPayload Json?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([gatewayTransactionId])
}

// ========================================
// MENTORS & SESSIONS
// ========================================

model Mentor {
  id              String  @id @default(cuid())
  userId          String  @unique
  bio             String? @db.Text
  expertiseTags   String? // e.g. "ESP32,Robotics"
  hourlyRateCents Int?
  isActive        Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects        ProjectMentor[]
  defaultProjects Project[]       @relation("DefaultMentorProjects")
  sessions        MentorSession[]

  @@index([isActive])
  @@index([userId])
}

model ProjectMentor {
  id        String     @id @default(cuid())
  projectId String
  mentorId  String
  role      MentorRole @default(PRIMARY)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  mentor  Mentor  @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@unique([projectId, mentorId])
  @@index([mentorId])
}

model MentorSession {
  id        String @id @default(cuid())
  studentId String
  mentorId  String
  projectId String

  status          MentorSessionStatus @default(REQUESTED)
  scheduledAt     DateTime?           @db.Timestamptz(6)
  durationMinutes Int?
  sessionLink     String?
  notes           String?             @db.Text

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  student User    @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  mentor  Mentor  @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([mentorId])
  @@index([projectId])
  @@index([status])
}

// ========================================
// ADMIN & FILE MANAGEMENT
// ========================================

model AdminActionLog {
  id         String  @id @default(cuid())
  adminId    String
  actionType String // e.g. "CREATE_PROJECT", "UPDATE_STOCK"
  targetType String? // e.g. "PROJECT", "KIT", "COMPONENT", "ORDER"
  targetId   String?
  details    Json?

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model FileUpload {
  id        String   @id @default(cuid())
  ownerId   String?
  projectId String?
  fileType  FileType
  url       String
  fileName  String?
  fileSize  Int? // in bytes

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  owner   User?    @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([ownerId])
  @@index([fileType])
}
